# Hebbia Datadog Explorer

**Tool:** `cd ~/Hebbia/sisu-notes && .venv/bin/python tools/datadog_explorer.py`

Query metrics, logs, and APM traces from Datadog. API keys in `tools/config.py`.

## 🔗 Direct Web UI URLs (Built-in)

**NEW: The Python tool now generates clickable URLs automatically!** Every query displays a direct link to the Datadog web UI at the end of the results.

### Automatic URL Generation

```bash
# URLs are now generated by default for all queries
.venv/bin/python tools/datadog_explorer.py "logs:run_get_rows_db_queries" --timeframe 2h
# Output format (simplified):
# 📝 logs:run_get_rows_db_queries [2h]
# → 100 log entries found
# 
#   [1] 2025-09-01 23:30:29 | sheets | info
#       run_get_rows_db_queries performance
#       DB: 0.4345s | Cache: True | Rows: 467
# 
# 🔗 https://app.datadoghq.com/logs?query=...

# Show direct links to individual log events (NEW!)
.venv/bin/python tools/datadog_explorer.py "logs:run_get_rows_db_queries" --event-urls
# Each log entry includes: 🔗 Direct link: https://app.datadoghq.com/logs?query=...&event=...

# Hide URLs if not needed
.venv/bin/python tools/datadog_explorer.py "logs:error" --no-url

# URLs work for all query types:
# - Logs: logs:*
# - APM Traces: traces:* or spans:*
# - Metrics: any metric query
```

### URL Format Reference

```
# Log Explorer URLs (general view)
https://app.datadoghq.com/logs?query=[QUERY]&from_ts=[MS]&to_ts=[MS]&live=true

# Log Explorer URLs (specific event) - NEW!
https://app.datadoghq.com/logs?query=[QUERY]&event=[EVENT_ID]&from_ts=[MS]&to_ts=[MS]
# Full params: &agg_m=count&cols=host%2Cservice&messageDisplay=inline&viz=stream&live=true

# APM Trace URLs
https://app.datadoghq.com/apm/traces?query=[QUERY]&start=[MS]&end=[MS]&paused=true

# Metrics Explorer URLs
https://app.datadoghq.com/metric/explorer?from_ts=[SEC]&to_ts=[SEC]&live=true&query=[QUERY]
```

## Essential Commands

### 🔍 Performance Investigation
```bash
# Get_rows performance logs (from final_report.md investigation)
.venv/bin/python tools/datadog_explorer.py "logs:run_get_rows_db_queries" --timeframe 2h

# Find slow queries (>1 second)
.venv/bin/python tools/datadog_explorer.py "logs:run_get_rows_db_queries" --raw | \
  jq '.data[] | select(.attributes.attributes.total_db_queries_time > 1)'

# Performance distribution analysis
.venv/bin/python tools/datadog_explorer.py "logs:run_get_rows_db_queries" --raw | \
  jq -r '.data[].attributes.attributes.total_db_queries_time' | \
  awk '{if($1<0.1) fast++; else if($1<1) normal++; else slow++} 
       END {printf "Fast: %d, Normal: %d, Slow: %d\n", fast, normal, slow}'

# Count occurrences of specific log patterns
.venv/bin/python tools/datadog_explorer.py "logs:\"slow get_relevant_rows query\"" --timeframe 24h --raw | \
  jq -r '.data | length'  # Returns up to 100 (API limit)
```

### 📝 Log Queries
```bash
# Basic log search
.venv/bin/python tools/datadog_explorer.py "logs:keyword"

# Service errors
.venv/bin/python tools/datadog_explorer.py "logs:service:sheets status:error"

# Complex filters
.venv/bin/python tools/datadog_explorer.py "logs:service:sheets run_get_rows_db_queries"

# Raw JSON for analysis
.venv/bin/python tools/datadog_explorer.py "logs:query" --raw
```

### 📊 Metrics
```bash
# Database performance
.venv/bin/python tools/datadog_explorer.py "avg:postgresql.connections{*}"
.venv/bin/python tools/datadog_explorer.py "avg:postgresql.query.time{*}"
.venv/bin/python tools/datadog_explorer.py "avg:postgresql.max_connections{*}"
.venv/bin/python tools/datadog_explorer.py "avg:postgresql.percent_usage_connections{*}"

# Database trace metrics (APM)
.venv/bin/python tools/datadog_explorer.py "avg:trace.postgres.connect{*}"
.venv/bin/python tools/datadog_explorer.py "avg:trace.postgres.query.time{*}"
.venv/bin/python tools/datadog_explorer.py "percentile:trace.postgres.query.time{*}:95"
.venv/bin/python tools/datadog_explorer.py "avg:trace.postgres.query.rows{*}"

# API latency
.venv/bin/python tools/datadog_explorer.py "avg:trace.request.duration{service:hebbia-api}"
.venv/bin/python tools/datadog_explorer.py "percentile:trace.request.duration{service:sheets}:95"

# System resources
.venv/bin/python tools/datadog_explorer.py "avg:system.cpu.idle{*}"
.venv/bin/python tools/datadog_explorer.py "avg:system.mem.used{*}"
```

### 🔎 Discovery
```bash
# List all metrics
.venv/bin/python tools/datadog_explorer.py "list-metrics"

# Search specific metrics
.venv/bin/python tools/datadog_explorer.py "list-metrics" --search "postgres"
.venv/bin/python tools/datadog_explorer.py "list-metrics" --search "trace"

# Get metric details
.venv/bin/python tools/datadog_explorer.py "info:postgresql.connections"
```

### 🔬 APM Traces (NEW)
```bash
# Query application traces
.venv/bin/python tools/datadog_explorer.py "traces:service:sheets" --timeframe 1h
# Output format:
# 🔍 traces:service:sheets [1h]
# → 50 trace spans found
#   [1] 2025-09-01 22:37:59 | sheets | sheets.api.matrix_api.get_rows | 2357.81ms

# Filter traces by duration (in nanoseconds)
.venv/bin/python tools/datadog_explorer.py "traces:service:sheets @duration:>1000000000" --timeframe 1h

# Get raw trace data for analysis
.venv/bin/python tools/datadog_explorer.py "traces:service:sheets" --raw | \
  jq '.data[].attributes | {resource_name, duration: .custom.duration}'

# Note: Database operations are not captured as separate spans
# Use application logs for database performance analysis instead
```

## Query Syntax

### Trace Query Syntax (NEW)
- **Prefix**: All trace queries start with `traces:`
- **Service**: `traces:service:sheets`
- **Duration**: `traces:@duration:>1000000000` (in nanoseconds, >1s)
- **Environment**: `traces:env:prod`
- **Combined**: `traces:service:sheets @duration:>1000000000`
- **Raw output**: Add `--raw` for JSON analysis with jq

### Log Query Syntax
- **Prefix**: All log queries start with `logs:`
- **Service**: `logs:service:sheets`
- **Status**: `logs:status:error` or `logs:status:warn`
- **Host**: `logs:host:ip-10-1-1-188`
- **Tags**: `logs:@tagname:value`
- **Text**: `logs:"exact phrase"` or `logs:keyword`
- **Multiple**: `logs:service:sheets status:error`

### Metric Aggregations
- `avg:` - Average
- `sum:` - Total
- `min:` / `max:` - Min/Max
- `count:` - Count
- `percentile:metric{*}:95` - 95th percentile

### Modifiers
- `.as_rate()` - Convert to rate/sec
- `.as_count()` - Convert to count
- `.rollup(avg, 60)` - 60s buckets
- `by {tag}` - Group by tag

### Timeframes

#### Relative Time (from now)
- Minutes: `5m`, `15m`, `30m`
- Hours: `1h` (default), `2h`, `4h`, `8h`, `12h`
- Days: `1d`, `2d`, `7d`, `14d`, `30d`

#### Custom Time Ranges (NEW!)
- **Single day**: `--timeframe "2025-01-03"` (entire day)
- **Date range**: `--timeframe "2025-01-03,2025-01-05"` (Jan 3-5)
- **ISO datetime**: `--timeframe "2025-01-03T10:00:00,2025-01-03T18:00:00"` (specific hours)
- **Unix seconds**: `--timeframe "1754539200,1754711999"` (epoch timestamps)
- **Unix milliseconds**: `--timeframe "1754539200000,1754711999999"` (auto-detected)

```bash
# Examples with custom timeframes
.venv/bin/python tools/datadog_explorer.py "logs:error" --timeframe "2025-01-03"
.venv/bin/python tools/datadog_explorer.py "logs:error" --timeframe "2025-01-03,2025-01-05"
.venv/bin/python tools/datadog_explorer.py "logs:error" --timeframe "1754539200000,1754711999999"
```

## Database Connection Analysis

### PostgreSQL Metrics
```bash
# Connection pool usage
.venv/bin/python tools/datadog_explorer.py "avg:postgresql.connections{*}" --timeframe 2h
.venv/bin/python tools/datadog_explorer.py "max:postgresql.connections{*}" --timeframe 2h
.venv/bin/python tools/datadog_explorer.py "avg:postgresql.percent_usage_connections{*}" --timeframe 2h

# Connection performance (from APM traces)
.venv/bin/python tools/datadog_explorer.py "avg:trace.postgres.connect{*}" --timeframe 2h
.venv/bin/python tools/datadog_explorer.py "max:trace.postgres.connect{*}" --timeframe 2h
.venv/bin/python tools/datadog_explorer.py "percentile:trace.postgres.connect{*}:95" --timeframe 2h

# Query performance
.venv/bin/python tools/datadog_explorer.py "avg:trace.postgres.query.time{*}" --timeframe 2h
.venv/bin/python tools/datadog_explorer.py "percentile:trace.postgres.query.time{*}:95" --timeframe 2h
.venv/bin/python tools/datadog_explorer.py "percentile:trace.postgres.query.time{*}:99" --timeframe 2h

# Connection analysis with filters
.venv/bin/python tools/datadog_explorer.py "avg:postgresql.connections{env:prod}" --timeframe 1h
.venv/bin/python tools/datadog_explorer.py "avg:trace.postgres.connect{env:prod,service:sheets}" --timeframe 1h
```

## Analysis Patterns

### Finding Performance Issues
```bash
# Query time distribution
.venv/bin/python tools/datadog_explorer.py "logs:run_get_rows_db_queries" --timeframe 6h --raw | \
  jq -r '.data[].attributes.attributes.total_db_queries_time' | \
  awk '{total+=$1; n++} END {printf "Avg: %.3fs (n=%d)\n", total/n, n}'

# Cache hit rate
.venv/bin/python tools/datadog_explorer.py "logs:run_get_rows_db_queries" --raw | \
  jq -r '.data[].attributes.attributes.cache_hit' | \
  grep -c true

# Slow sheet identification
.venv/bin/python tools/datadog_explorer.py "logs:run_get_rows_db_queries" --raw | \
  jq -r 'select(.attributes.attributes.total_db_queries_time > 5) | 
         "\(.attributes.attributes.sheet): \(.attributes.attributes.total_db_queries_time)s"'
```

### Error Analysis
```bash
# Error rate by service
.venv/bin/python tools/datadog_explorer.py "logs:status:error" --raw | \
  jq -r '.data[].attributes.service' | sort | uniq -c | sort -rn

# Transaction rollbacks
.venv/bin/python tools/datadog_explorer.py "logs:\"rolling back transaction\"" --timeframe 1h

# Parse failures
.venv/bin/python tools/datadog_explorer.py "logs:\"Failed to parse\"" --timeframe 1h
```

## Key Findings from Investigation

From analyzing `get_rows` performance:

### Application Logs
- **10% of queries are critical** (>1 second execution time)
- **Average DB query time: 0.704s** even with cache hits
- **Missing indexes** cause 48+ second queries (see final_report.md)
- **Common errors**: Transaction rollbacks, parse failures

### APM Traces (NEW)
- **_get_relevant_rows_cached**: 2.8-3.1 second operations confirmed
- **/ssrm/get-rows**: API endpoints taking 3.7-10 seconds
- **Database spans**: Not captured separately, included in application spans
- **Slow operations**: 100+ traces >1 second found in 2-hour window

## Quick Reference

```bash
# Most useful commands for debugging (URLs included automatically!)
alias ddlogs='cd ~/Hebbia/sisu-notes && .venv/bin/python tools/datadog_explorer.py'

# Recent performance logs → with clickable URL
ddlogs "logs:run_get_rows_db_queries" --timeframe 1h

# Current errors → with clickable URL
ddlogs "logs:service:sheets status:error" --timeframe 15m

# Database load → with clickable URL
ddlogs "avg:postgresql.connections{*}" --timeframe 1h
ddlogs "avg:postgresql.percent_usage_connections{*}" --timeframe 1h

# Database performance (APM traces) → with clickable URL
ddlogs "avg:trace.postgres.connect{*}" --timeframe 1h
ddlogs "percentile:trace.postgres.query.time{*}:95" --timeframe 1h

# API latency → with clickable URL
ddlogs "percentile:trace.request.duration{service:sheets}:95" --timeframe 1h

# CUSTOM TIMERANGES (NEW!)
# Query specific dates
ddlogs "logs:error" --timeframe "2025-01-03"  # Single day
ddlogs "logs:error" --timeframe "2025-01-03,2025-01-05"  # Date range

# Copy timestamps from Datadog web URLs
ddlogs "logs:error" --timeframe "1754539200000,1754711999999"  # From URL params

# Precise time windows
ddlogs "logs:error" --timeframe "2025-01-03T09:00:00,2025-01-03T17:00:00"  # Business hours

# Hide URLs when not needed
ddlogs "logs:error" --no-url

# Output raw JSON (no formatting, no URLs)
ddlogs "logs:error" --raw
```

## Important Limitations & Learnings

### API Limitations
- **Log Results**: Maximum 100 logs returned per query (use timeframe to narrow)
- **APM Traces**: Database operations not captured as separate spans in application traces
  - `resource_name:postgres` queries return no results
  - Database timing must be inferred from application-level logs
- **Metric Names**: PostgreSQL connection metrics not available via standard trace metrics
- **Connection Logs**: SQLAlchemy/psycopg2 connection timing not logged by default

### Working Alternatives
- Use AWS CloudWatch for RDS Proxy metrics instead of Datadog APM
- Search for application-level slow query logs instead of connection traces
- Use `--raw` output with jq for complex filtering and counting

### Common Pitfalls
- Searching for `trace.postgres.*` metrics returns no data
- `resource_name:*postgres*` in logs doesn't match database operations
- Connection pool logs often about LaunchDarkly, not PostgreSQL

## Recent Tool Enhancements

### 2025-09-02 (Today - Latest v3)
- **Simplified Output Format**: Cleaner, more concise output that shows query on first line
  - Query shown immediately: `🔍 traces:resource_name:*get_rows* @duration:>2000000000 [2h]`
  - No verbose connection messages
  - Compact result display: `[1] 2025-09-01 22:37:59 | sheets | get_rows | 2357.81ms`
  - Single-line URL display: `🔗 https://app.datadoghq.com/...`

### 2025-09-02 (Today - Latest v2)
- **Custom Timerange Support**: Added ability to specify exact date ranges using various formats
- **Unix Timestamp Support**: Accepts both seconds and milliseconds (auto-detected)
- **Date Range Queries**: Query specific days or date ranges like "2025-01-03,2025-01-05"
- **ISO Datetime Support**: Precise hour/minute ranges with ISO format
- **Web URL Compatibility**: Can extract timestamps from Datadog URLs (e.g., from_ts=1754539200000&to_ts=1754711999999)

Example matching your Datadog URL:
```bash
# Extract timestamps from URL: from_ts=1754539200000&to_ts=1754711999999
.venv/bin/python tools/datadog_explorer.py "logs:run_get_rows_db_queries" --timeframe "1754539200000,1754711999999"

# Or use human-readable dates (Jan 3-5, 2025)
.venv/bin/python tools/datadog_explorer.py "logs:run_get_rows_db_queries" --timeframe "2025-01-03,2025-01-05"
```

### 2025-09-02 (Today - Latest)
- **Event-Specific URLs**: New `--event-urls` flag shows direct links to individual log events
- **Enhanced Log URLs**: URLs now include full viewing parameters (columns, aggregation, etc.)
- **Event ID Support**: Direct navigation to specific log events with unique event IDs

### 2025-09-02 (Today - Earlier)
- **Automatic URL Generation**: Tool now generates clickable Datadog web UI URLs by default
- **Direct Web Access**: Every query result includes a link to explore further in Datadog UI
- **Optional URL Hiding**: New `--no-url` flag to suppress URLs when not needed

### 2025-09-02 (Earlier)
- **APM Trace Support Added**: New `traces:` prefix for querying application performance traces
- **Duration Filtering**: Support for @duration filters to find slow operations
- **Raw Trace Analysis**: Full JSON output with --raw flag for detailed analysis
- **Confirmed Finding**: _get_relevant_rows_cached operations taking 2.8-3.1 seconds

## Troubleshooting

- **SSL Warning**: Ignore LibreSSL warnings - non-critical
- **No data**: Expand timeframe or check service name
- **Rate limit**: 1000 requests/hour for metrics
- **Authentication**: Verify keys in tools/config.py
- **Empty results**: Try broader search terms, check service names
- **No database spans**: Database operations included in application spans, not separate
